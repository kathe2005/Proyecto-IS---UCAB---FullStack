<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Diagrama de Clases — Backend</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Diagrama de Clases — Backend (ordenado)</h1>
    <p>Representación organizada de controladores, servicios, repositorios, modelos y utilidades de persistencia.</p>
  </header>

  <main>
    <div class="diagram-wrap">
      <svg id="uml" viewBox="0 0 1400 1000" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Diagrama de clases backend">

        <!-- Definitions -->
        <defs>
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="5" orient="auto">
            <path d="M0,0 L10,5 L0,10 z" fill="#222" />
          </marker>
          <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.08"/>
          </filter>
        </defs>

        <!-- Top row: Controllers -->
        <g class="class" id="ClienteController" transform="translate(60,40)">
          <rect class="box" width="420" height="72" rx="6" filter="url(#shadow)"/>
          <text class="title" x="210" y="24" text-anchor="middle">ClienteController</text>
          <line x1="10" y1="36" x2="410" y2="36" stroke="#222"/>
          <text class="member" x="16" y="54">+ POST /api/clientes → registrarCliente()</text>
        </g>

        <g class="class" id="ReservaController" transform="translate(520,40)">
          <rect class="box" width="520" height="72" rx="6" filter="url(#shadow)"/>
          <text class="title" x="260" y="24" text-anchor="middle">ReservaController</text>
          <line x1="10" y1="36" x2="510" y2="36" stroke="#222"/>
          <text class="member" x="16" y="54">+ GET /api/reservas/disponibles → consultarPuestosDisponibles()</text>
        </g>

        <!-- Second row: Services & Impl -->
        <g class="class" id="ClienteService" transform="translate(60,150)">
          <rect class="box" width="360" height="120" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">ClienteService (interface)</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">+ registrarCliente(Cliente): Cliente</text>
          <text class="member" x="16" y="78">+ actualizarCliente(Cliente): Cliente</text>
          <text class="member" x="16" y="100">+ obtenerTodos(): List<Cliente></text>
        </g>

        <g class="class" id="ClienteServiceImpl" transform="translate(460,150)">
          <rect class="box" width="420" height="120" rx="6"/>
          <text class="title" x="210" y="22" text-anchor="middle">ClienteServiceImpl</text>
          <line x1="10" y1="36" x2="410" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">- clienteRepository: ClienteRepositoryPort</text>
          <text class="member" x="16" y="78">+ registrarCliente(...)</text>
          <text class="member" x="16" y="100">+ validarFormatoCedula(...)</text>
        </g>

        <g class="class" id="ReservaService" transform="translate(920,150)">
          <rect class="box" width="360" height="120" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">ReservaService (interface)</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">+ crearReserva(ReservaRequest): Reserva</text>
          <text class="member" x="16" y="78">+ consultarPuestosDisponibles(fecha, turno, clienteId?): PuestosDisponiblesResponse</text>
          <text class="member" x="16" y="100">+ obtenerReservasPorCliente(clienteId)</text>
        </g>

        <g class="class" id="ReservaServiceImpl" transform="translate(920,300)">
          <rect class="box" width="360" height="120" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">ReservaServiceImpl</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">- jsonManagerReserva: JsonManagerReserva</text>
          <text class="member" x="16" y="78">- jsonManagerPuestos: JsonManager</text>
          <text class="member" x="16" y="100">+ consultarPuestosDisponibles(...)</text>
        </g>

        <!-- Third column: Repositories / JSON managers -->
        <g class="class" id="ClienteRepository" transform="translate(60,320)">
          <rect class="box" width="360" height="110" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">ClienteRepository (JSON)</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">- file: data/clientes.json</text>
          <text class="member" x="16" y="78">+ save(cliente): Cliente</text>
        </g>

        <g class="class" id="ClienteRepositoryPort" transform="translate(440,320)">
          <rect class="box" width="300" height="110" rx="6"/>
          <text class="title" x="150" y="22" text-anchor="middle">ClienteRepositoryPort (port)</text>
          <line x1="10" y1="36" x2="290" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">+ save(Cliente): Cliente</text>
          <text class="member" x="16" y="76">+ findAll(): List&lt;Cliente&gt;</text>
          <text class="member" x="16" y="96">+ findByUsuario/Email/Cedula/Telefono()</text>
        </g>

        <g class="class" id="JsonManager" transform="translate(460,320)">
          <rect class="box" width="360" height="90" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">JsonManager (puestos)</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="58">+ cargarPuestos(): List<Puesto></text>
        </g>

        <g class="class" id="JsonManagerReserva" transform="translate(860,420)">
          <rect class="box" width="360" height="90" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">JsonManagerReserva</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="58">+ cargarReservas(): List<Reserva></text>
        </g>

        <!-- Puesto service + impl (detallado) -->
        <g class="class" id="PuestoService" transform="translate(60,520)">
          <rect class="box" width="360" height="110" rx="6"/>
          <text class="title" x="180" y="22" text-anchor="middle">PuestoService (interface)</text>
          <line x1="10" y1="36" x2="350" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">+ obtenerPuestos(): List&lt;Puesto&gt;</text>
          <text class="member" x="16" y="76">+ obtenerPuestosPorEstado(EstadoPuesto)</text>
          <text class="member" x="16" y="96">+ ocuparPuesto(...), liberarPuesto(...), reasignarPuesto(...)</text>
        </g>

        <g class="class" id="PuestoServiceImpl" transform="translate(460,520)">
          <rect class="box" width="420" height="110" rx="6"/>
          <text class="title" x="210" y="22" text-anchor="middle">PuestoServiceImpl</text>
          <line x1="10" y1="36" x2="410" y2="36" stroke="#222"/>
          <text class="member" x="16" y="56">- jsonManager: JsonManager</text>
          <text class="member" x="16" y="76">+ obtenerPuestos()</text>
          <text class="member" x="16" y="96">+ ocuparPuesto(...)</text>
            <div class="diagram-wrap">
              <div class="diagram-toolbar">
                <button id="download-svg" class="btn" title="Descargar SVG">Descargar SVG</button>
                <button id="export-png" class="btn" title="Exportar PNG">Exportar PNG</button>
              </div>
              <!-- Component Diagram: muestra componentes y sus relaciones (basado en el código del backend/frontend) -->
              <svg id="component-diagram" viewBox="0 0 1400 820" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Diagrama de componentes">
                <defs>
                  <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="5" orient="auto">
                    <path d="M0,0 L10,5 L0,10 z" fill="#222" />
                  </marker>
                </defs>

                <!-- Frontend -->
                <g class="component" id="frontend" transform="translate(40,40)">
                  <rect class="cbox" width="320" height="90" rx="8"/>
                  <text class="ctitle" x="160" y="28" text-anchor="middle">Frontend (Angular)</text>
                  <text class="cinfo" x="160" y="52" text-anchor="middle">`frontend/src/app` · UI, servicios HTTP</text>
                </g>

                <!-- API / Controllers -->
                <g class="component" id="api" transform="translate(400,40)">
                  <rect class="cbox" width="420" height="140" rx="8"/>
                  <text class="ctitle" x="210" y="28" text-anchor="middle">API Layer — Controllers</text>
                  <text class="cinfo" x="210" y="52" text-anchor="middle">`/api/clientes`, `/api/reservas`, `/puestos`</text>
                  <text class="cinfo" x="210" y="72" text-anchor="middle">Clases: ClienteController, ReservaController, PuestoController</text>
                </g>

                <!-- Business Services -->
                <g class="component" id="services" transform="translate(400,220)">
                  <rect class="cbox" width="760" height="140" rx="8"/>
                  <text class="ctitle" x="380" y="28" text-anchor="middle">Business Layer — Services</text>
                  <text class="cinfo" x="380" y="52" text-anchor="middle">Interfaces + Implementaciones</text>
                  <text class="cinfo" x="380" y="72" text-anchor="middle">ClienteServiceImpl, ReservaServiceImpl, PuestoServiceImpl</text>
                  <text class="cinfo" x="380" y="92" text-anchor="middle">Validaciones, reglas de negocio, orquestación</text>
                </g>

                <!-- Persistence / Repositories -->
                <g class="component" id="persistence" transform="translate(60,400)">
                  <rect class="cbox" width="520" height="140" rx="8"/>
                  <text class="ctitle" x="260" y="28" text-anchor="middle">Persistence — Repositorios / JSON</text>
                  <text class="cinfo" x="260" y="52" text-anchor="middle">Implementaciones: ClienteRepository (JSON)</text>
                  <text class="cinfo" x="260" y="72" text-anchor="middle">Adaptadores: JsonManager (puestos), JsonManagerReserva</text>
                  <text class="cinfo" x="260" y="92" text-anchor="middle">Ports: ClienteRepositoryPort</text>
                </g>

                <!-- Data files -->
                <g class="component" id="data" transform="translate(620,400)">
                  <rect class="cbox" width="300" height="80" rx="8"/>
                  <text class="ctitle" x="150" y="28" text-anchor="middle">Data</text>
                  <text class="cinfo" x="150" y="52" text-anchor="middle">`data/clientes.json` · `data/puestos.json` · `data/reservas.json`</text>
                </g>

                <!-- Domain Models (shared) -->
                <g class="component" id="models" transform="translate(940,400)">
                  <rect class="cbox" width="360" height="120" rx="8"/>
                  <text class="ctitle" x="180" y="28" text-anchor="middle">Domain Models</text>
                  <text class="cinfo" x="180" y="52" text-anchor="middle">Cliente, Puesto, Reserva, DTOs (ReservaRequest, PuestosDisponiblesResponse)</text>
                </g>

                <!-- Arrows: Frontend -> API -->
                <line x1="360" y1="85" x2="400" y2="85" stroke="#0b6" stroke-width="2" marker-end="url(#arrow)" />
                <text x="250" y="70" class="note">HTTP (REST)</text>

                <!-- API -> Services -->
                <line x1="610" y1="180" x2="610" y2="220" stroke="#0b6" stroke-width="2" marker-end="url(#arrow)" />
                <text x="620" y="170" class="note">Invoca / Orquesta</text>

                <!-- Services -> Persistence -->
                <line x1="580" y1="330" x2="320" y2="400" stroke="#09f" stroke-width="2" marker-end="url(#arrow)" />
                <text x="460" y="360" class="note">Lee / Escribe</text>

                <!-- Persistence -> Data -->
                <line x1="580" y1="440" x2="620" y2="440" stroke="#09f" stroke-width="2" marker-end="url(#arrow)" />

                <!-- Services -> Models (uso compartido) -->
                <line x1="840" y1="260" x2="940" y2="400" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)" />

              </svg>
            </div>

            <script>
              // Helper: download raw SVG
              function downloadSVG() {
                const svg = document.getElementById('component-diagram');
                if (!svg) { alert('SVG no encontrado'); return; }
                const serializer = new XMLSerializer();
                let source = serializer.serializeToString(svg);
                if (!source.match(/^<svg[^>]+xmlns="http:\/\/www.w3.org\/2000\/svg"/)) {
                  source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!source.match(/^<svg[^>]+xmlns:xlink=/)) {
                  source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }
                const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'component-diagram.svg';
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
              }

              // Helper: export SVG to PNG using canvas
              function exportPNG() {
                const svg = document.getElementById('component-diagram');
                if (!svg) { alert('SVG no encontrado'); return; }

                const viewBox = svg.getAttribute('viewBox');
                let vb = [0,0,1400,820];
                if (viewBox) {
                  const parts = viewBox.split(/\s+/).map(Number);
                  if (parts.length === 4 && parts.every(n => !isNaN(n))) vb = parts;
                }

                const serializer = new XMLSerializer();
                let source = serializer.serializeToString(svg);
                if (!source.match(/^<svg[^>]+xmlns="http:\/\/www.w3.org\/2000\/svg"/)) {
                  source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                source = '<?xml version="1.0" standalone="no"?>\n' + source;
                const svgBlob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                const img = new Image();
                img.onload = function() {
                  const canvas = document.createElement('canvas');
                  canvas.width = vb[2];
                  canvas.height = vb[3];
                  const ctx = canvas.getContext('2d');
                  // white background
                  ctx.fillStyle = '#ffffff';
                  ctx.fillRect(0,0,canvas.width,canvas.height);
                  ctx.drawImage(img, 0, 0);
                  URL.revokeObjectURL(url);
                  canvas.toBlob(function(blob) {
                    const a = document.createElement('a');
                    const pngUrl = URL.createObjectURL(blob);
                    a.href = pngUrl;
                    a.download = 'component-diagram.png';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(pngUrl), 1000);
                  }, 'image/png');
                };
                img.onerror = function(e) { alert('Error exportando PNG'); URL.revokeObjectURL(url); };
                img.src = url;
              }

              document.addEventListener('DOMContentLoaded', function() {
                const btnSvg = document.getElementById('download-svg');
                const btnPng = document.getElementById('export-png');
                if (btnSvg) btnSvg.addEventListener('click', downloadSVG);
                if (btnPng) btnPng.addEventListener('click', exportPNG);
              });
            </script>